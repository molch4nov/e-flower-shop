# E-Flower Shop: Задачи по разработке фронтенда

## Общая информация о проекте

**E-Flower Shop** - интернет-магазин цветов и букетов с функциями онлайн-заказа и доставки. На стороне бэкенда уже реализован полноценный REST API, но фронтенд требует доработки. Задачи в этом документе фокусируются на нереализованной функциональности фронтенда, для которой уже готовы соответствующие API-эндпоинты на бэкенде.

## Текущее состояние фронтенда

Фронтенд уже имеет некоторую базовую реализацию, включая:
- Аутентификацию (логин/регистрация)
- Простой профиль пользователя
- Базовые страницы заказов и корзины
- Основную структуру приложения на React с React Router
- Главную страницу

## Задачи для разработки фронтенда

### 1. Каталог товаров и категории

- [x] **1.1 Компонент CategoryList для отображения категорий**
  - Разработать компонент для отображения категорий с иконками
  - Добавить возможность фильтрации по категориям
  - Реализовать получение категорий через API (`GET /api/categories`)
  - Успешные критерии: категории отображаются со своими названиями, пользователь может переходить к товарам выбранной категории

- [x] **1.2 Страница категорий с подкатегориями**
  - Создать страницу для просмотра подкатегорий выбранной категории
  - Добавить интерактивные карточки подкатегорий
  - Реализовать получение подкатегорий через API (`GET /api/categories/:id/subcategories`)
  - Успешные критерии: подкатегории отображаются корректно, пользователь может переходить к товарам выбранной подкатегории

- [x] **1.3 Каталог товаров по подкатегориям**
  - Создать страницу каталога товаров с фильтрацией по подкатегории
  - Реализовать пагинацию или бесконечную прокрутку
  - Добавить сортировку (по цене, популярности, рейтингу)
  - Использовать API (`GET /api/products/subcategory/:subcategoryId`)
  - Успешные критерии: товары корректно отображаются, работает пагинация и сортировка

### 2. Детализация товаров

- [x] **2.1 Страница детального просмотра товара**
  - Создать детальную страницу товара с изображениями, описанием
  - Для букетов добавить отображение состава (цветы, количество)
  - Добавить секцию отзывов
  - Реализовать добавление в корзину
  - Использовать API (`GET /api/products/:id`)
  - Успешные критерии: вся информация о товаре корректно отображается, кнопка добавления в корзину работает

- [x] **2.2 Компонент отзывов о товаре**
  - Создать компонент для отображения отзывов
  - Добавить функцию оставления нового отзыва для авторизованных пользователей
  - Реализовать просмотр существующих отзывов с рейтингом и датой
  - Использовать API (`GET /api/reviews/product/:productId`, `POST /api/reviews`)
  - Успешные критерии: отзывы отображаются с рейтингом и датой, авторизованные пользователи могут оставить отзыв

### 3. Усовершенствование корзины

- [x] **3.1 Улучшение функциональности корзины**
  - Доработать интерфейс корзины с отображением товаров, цены, количества
  - Добавить изменение количества товаров через + и - кнопки
  - Реализовать удаление товаров и очистку корзины
  - Использовать API (`GET /api/cart`, `PUT /api/cart/:id`, `DELETE /api/cart/:id`, `DELETE /api/cart/clear`)
  - Успешные критерии: корзина отображает все товары и их количество, пользователь может менять количество и удалять товары

- [x] **3.2 Расширенная форма оформления заказа**
  - Создать многошаговую форму оформления заказа
  - Добавить выбор даты и времени доставки с валидацией
  - Добавить ввод и сохранение адреса доставки
  - Реализовать создание заказа через API (`POST /api/orders`)
  - Успешные критерии: пользователь может пройти весь процесс оформления заказа, все данные корректно валидируются и отправляются

### 4. Улучшение страницы заказов

- [x] **4.1 Улучшенный интерфейс истории заказов**
  - Доработать компонент отображения заказов пользователя
  - Добавить фильтрацию по статусу
  - Включить подробную информацию о заказе (статус, дата, сумма)
  - Использовать API (`GET /api/orders`)
  - Успешные критерии: пользователь видит историю своих заказов с полной информацией о каждом заказе

- [x] **4.2 Страница детального просмотра заказа**
  - Создать страницу для просмотра подробной информации о заказе
  - Отображать список товаров, адрес, дату и время доставки, статус
  - Добавить отслеживание статуса заказа
  - Использовать API (`GET /api/orders/:id`)
  - Успешные критерии: пользователь может просмотреть полную информацию о своем заказе, включая состав и статус

### 5. Расширение профиля пользователя

- [x] **5.1 Улучшенный профиль пользователя**
  - Расширить страницу профиля дополнительными данными
  - Добавить форму редактирования профиля
  - Включить раздел сохраненных адресов
  - Использовать API (`GET /api/user/profile`, `PUT /api/user/profile`)
  - Успешные критерии: пользователь видит и может редактировать все свои данные

- [x] **5.2 Управление адресами доставки**
  - Создать интерфейс для добавления, редактирования и удаления адресов
  - Реализовать установку адреса по умолчанию
  - Использовать API (`GET /api/user/addresses`, `POST /api/user/addresses`, `PUT /api/user/addresses/:id`, `DELETE /api/user/addresses/:id`)
  - Успешные критерии: пользователь может управлять своими адресами доставки

### 6. Поиск и спецпредложения

- [ ] **6.1 Глобальный поиск товаров**
  - Реализовать компонент поиска в шапке сайта
  - Добавить страницу результатов поиска с фильтрацией
  - Использовать API (`GET /api/products?search=...`)
  - Успешные критерии: пользователь может искать товары по названию и видеть результаты

- [ ] **6.2 Отображение популярных и топовых товаров**
  - Создать компоненты для отображения популярных товаров и товаров с высоким рейтингом
  - Интегрировать их на главную страницу
  - Использовать API (`GET /api/products/popular`, `GET /api/products/top-rated`)
  - Успешные критерии: на главной странице отображаются блоки с популярными товарами и товарами с высоким рейтингом

### 7. Управление праздниками пользователя

- [x] **7.1 Секция праздников в профиле**
  - Добавить в профиль раздел с важными праздниками пользователя
  - Реализовать добавление, редактирование и удаление праздников
  - Использовать API (`GET /api/user/holidays`, `POST /api/user/holidays`, `PUT /api/user/holidays/:id`, `DELETE /api/user/holidays/:id`)
  - Успешные критерии: пользователь может управлять списком своих праздников

### 8. Улучшения UI/UX

- [ ] **8.1 Индикаторы загрузки и состояния**
  - Добавить скелетонную загрузку для товаров
  - Реализовать состояния загрузки для форм
  - Добавить анимации для улучшения восприятия
  - Успешные критерии: пользователь видит индикаторы загрузки при ожидании данных

- [ ] **8.2 Мобильная адаптация**
  - Оптимизировать все компоненты для мобильных устройств
  - Добавить мобильное меню
  - Реализовать адаптивные сетки для каталога товаров
  - Успешные критерии: сайт корректно отображается и функционирует на мобильных устройствах

## Приоритеты разработки

1. Каталог товаров и категории (задачи 1.1 - 1.3)
2. Детализация товаров (задачи 2.1 - 2.2)
3. Усовершенствование корзины (задачи 3.1 - 3.2)
4. Улучшение страницы заказов (задачи 4.1 - 4.2)
5. Расширение профиля пользователя (задачи 5.1 - 5.2)
6. Поиск и спецпредложения (задачи 6.1 - 6.2)
7. Управление праздниками пользователя (задача 7.1)
8. Улучшения UI/UX (задачи 8.1 - 8.2)

## Project Status Board

- [x] Базовая настройка проекта
- [x] Настройка маршрутизации (React Router)
- [x] Создание страниц авторизации
- [x] Создание компонента ProductCard
- [x] Базовый интерфейс корзины
- [x] Кнопка "Категории" всегда видна и адаптивна (десктоп/мобайл)
- [x] В Drawer осталась только одна кнопка "Закрыть" (правый верхний угол)
- [x] Исправлена обработка ошибок при получении категорий (UI-friendly)
- [x] Реализован профиль пользователя с отображением имени, телефона, даты рождения
- [x] Добавлена форма редактирования профиля
- [x] Создан интерфейс отображения адресов пользователя
- [x] Добавлена секция для праздников пользователя
- [x] Реализована функциональность корзины (отображение товаров, изменение количества, удаление)
- [x] Создан интерфейс истории заказов с подробной информацией
- [x] Создана страница просмотра деталей заказа (товары, адрес, дата, статус)
- [x] Реализована страница каталога товаров с фильтрацией и сортировкой
- [x] Создана страница детального просмотра товара с информацией и галереей изображений
- [x] Добавлен компонент отзывов с возможностью оставить новый отзыв
- [x] Обновлен навбар (удалены лишние ссылки, добавлена корзина с отображением количества товаров)
- [x] Реализована расширенная форма оформления заказа (многошаговая форма с выбором адреса, даты/времени доставки)
- [ ] Переход от категорий к подкатегориям с анимацией свайпа (Drawer)
- [ ] Загрузка и отображение подкатегорий через API
- [ ] Кнопка возврата к списку категорий с обратной анимацией
- [ ] Загрузка картинок в отзывах

## Executor's Feedback or Assistance Requests

**ВЫПОЛНЕНО: Исправление проблем с изображениями товаров и загрузкой фотографий в отзывах**

Обнаружены и исправлены две проблемы с файлами:

1. **Проблема с отображением изображений товаров:**
   - В `fileController.js` использовался заголовок `Content-Disposition: attachment`
   - Это заставляло браузер скачивать изображения вместо их отображения
   - **Исправление:** Изменил на `Content-Disposition: inline` для изображений, оставил `attachment` только для других типов файлов

2. **Проблема с загрузкой фотографий в отзывах:**
   - В `ReviewForm.tsx` использовались прямые fetch запросы вместо API клиента
   - Это могло приводить к проблемам с маршрутизацией и обработкой ошибок
   - **Исправление:** Заменил fetch запросы на api.post() и api.upload() для единообразной работы

3. **Дополнительные улучшения:**
   - Заменил прямые fetch запросы в `ProductDetailPage.tsx` на использование API клиента
   - Унифицировал работу с API во всех компонентах для корректной маршрутизации

4. **Результат:**
   - ✅ Изображения товаров теперь корректно отображаются в браузере
   - ✅ Загрузка фотографий в отзывах работает через единый API клиент
   - ✅ Все запросы маршрутизируются на правильный порт backend (3000)
   - ✅ Улучшена обработка ошибок благодаря централизованному API клиенту

**РАНЕЕ ВЫПОЛНЕНО: Исправление ошибок с неправильными URL API и колонкой image_url**

Обнаружены и исправлены две связанные проблемы:

1. **Проблема с URL API запросов:**
   - В `OrderDetailPage.tsx` и `OrdersPage.tsx` использовались относительные URL `/api/orders/...`
   - Это приводило к запросам на фронтенд (порт 5173) вместо бэкенда (порт 3000)
   - Результат: ошибка 404 Not Found при попытке получить детали заказа

2. **Проблема с колонкой image_url:**
   - В `Order.js` модели backend запрос пытался получить `image_url` из таблицы `product_images`
   - В реальной структуре БД колонка называется `url`, а не `image_url`
   - Результат: ошибка "column 'image_url' does not exist" при создании заказа

3. **Исправления:**
   - Заменил прямые fetch запросы на использование API клиента во всех компонентах
   - Исправил SQL запрос в `getOrderItems()` заменив `image_url` на `url`
   - Обновил сортировку изображений по `is_main DESC, created_at` для выбора главного изображения
   - Импортировал API клиент в `OrderDetailPage.tsx` и `OrdersPage.tsx`

4. **Результат:**
   - Устранена ошибка 404 при загрузке деталей заказа
   - Устранена ошибка "column does not exist" при создании заказа
   - Все API запросы теперь корректно идут на backend (порт 3000)
   - Унифицирована работа с API через единый клиент

**РАНЕЕ ВЫПОЛНЕНО: Исправление ошибки дублирующихся ключей React в каталоге товаров**

Обнаружена и исправлена проблема с дублирующимися ключами React на странице каталога:

1. **Проблема:** 
   - React выдавал предупреждение "Encountered two children with the same key"
   - При infinite scroll API возвращал дублирующиеся товары с одинаковыми ID
   - Эти дубликаты добавлялись в список и создавали конфликт ключей в React

2. **Исправления:**
   - Добавил фильтрацию дубликатов при добавлении новых товаров (append=true)
   - Использую `Set` для быстрой проверки существующих ID
   - Обновил логику `hasMore` чтобы учесть фильтрацию дубликатов
   - Теперь infinite scroll корректно определяет когда товары закончились

3. **Результат:**
   - Устранено предупреждение React о дублирующихся ключах
   - Каждый товар отображается только один раз в списке
   - Infinite scroll работает без дублирования товаров
   - Правильно определяется конец списка товаров

**РАНЕЕ ВЫПОЛНЕНО: Исправление бесконечного ререндера в каталоге товаров**

Обнаружена и исправлена проблема с бесконечным циклом ререндера на странице `/catalog/all?sort=popular`:

1. **Проблема:** 
   - В `AllProductsCatalogPage.tsx` функция `fetchProducts` включала `loading` и `loadingMore` в зависимости `useCallback`
   - Эти состояния изменялись внутри самой функции, что приводило к её пересозданию
   - `useEffect` реагировал на изменение функции и вызывал её снова
   - Создавался бесконечный цикл: функция вызывается → состояние меняется → функция пересоздается → useEffect срабатывает → повторяется

2. **Исправления:**
   - Убрал `loading` и `loadingMore` из зависимостей `useCallback` для `fetchProducts`
   - Добавил `useRef` для хранения стабильной ссылки на функцию `fetchProducts`
   - Обновил все `useEffect` для использования `fetchProductsRef.current` вместо прямого вызова функции
   - Убрал циклические зависимости из `useEffect` с Intersection Observer

3. **Результат:**
   - Устранен бесконечный ререндер на странице каталога
   - Страница загружается корректно с параметром `sort=popular`
   - Infinite scroll и фильтрация работают без зацикливания

**РАНЕЕ ВЫПОЛНЕНО: Исправление ошибки с UUID при работе с праздниками и адресами**

Обнаружена и исправлена критическая ошибка с типами данных:

1. **Проблема:** 
   - В базе данных таблицы `user_holidays` и `user_addresses` используют UUID для id колонок
   - В контроллерах `userController.js` код пытался преобразовать ID через `parseInt()` 
   - Это приводило к ошибке "invalid input syntax for type uuid" при попытке обновления/удаления

2. **Исправленные функции backend:**
   - `getHolidayById()` - убран parseInt для holidayId
   - `updateHoliday()` - убран parseInt для holidayId  
   - `deleteHoliday()` - убран parseInt для holidayId
   - `getAddressById()` - убран parseInt для addressId
   - `updateAddress()` - убран parseInt для addressId
   - `deleteAddress()` - убран parseInt для addressId
   - `setAddressAsDefault()` - убран parseInt для addressId

3. **Исправления frontend:**
   - Изменены типы интерфейсов Address и Holiday: `id: number` → `id: string`
   - Обновлены сигнатуры функций для работы со строковыми UUID

4. **Результат:**
   - Устранена ошибка "invalid input syntax for type uuid"
   - Теперь операции с адресами и праздниками работают корректно
   - UUID корректно передаются между frontend и backend

**РАНЕЕ ВЫПОЛНЕНО: Исправление отображения адресов пользователя**

Проблема была в неправильной обработке ответов API в ProfilePage.tsx:

1. **Исправленные функции:**
   - `fetchAddresses()` - убрана проверка response.ok и response.json(), теперь использует data напрямую от api.get()
   - `fetchHolidays()` - аналогично исправлена
   - `fetchOrders()` - аналогично исправлена
   - `handleAddressSubmit()` - переписана для использования api.post()/api.put() вместо прямого fetch
   - `setDefaultAddress()` - убрана проверка response.ok
   - `deleteAddress()` - убрана проверка response.ok  
   - `deleteHoliday()` - убрана проверка response.ok
   - `handleHolidaySubmit()` - переписана для использования api.post()/api.put()

2. **Корень проблемы:** 
   - API клиент (config/api.ts) уже обрабатывает ошибки и возвращает готовые данные
   - Функции ProfilePage пытались обрабатывать ответ как обычный fetch response
   - Это приводило к ошибкам и блокировало отображение данных

3. **Результат:** 
   - Адреса теперь должны корректно загружаться и отображаться в профиле
   - Исправлена работа всех CRUD операций с адресами и праздниками
   - Унифицировано использование API клиента во всех функциях

# Lessons
- Если API возвращает не JSON, показывать пользователю понятное сообщение, а не техническую ошибку.
- Не дублировать кнопки закрытия Drawer — лучше оставить одну, наиболее привычную для пользователя (правый верхний угол).
- Для анимаций между экранами в Drawer можно использовать CSS transitions или легковесные решения, чтобы не тянуть тяжелые зависимости.
- **API клиент уже обрабатывает ответы:** При использовании кастомного API клиента (config/api.ts) не нужно дополнительно проверять response.ok или вызывать response.json() - клиент уже возвращает готовые данные или выбрасывает ошибки. Смешивание подходов (api.get + response.ok) приводит к ошибкам.
- **Соответствие типов данных критично:** При использовании UUID в базе данных нужно убедиться что frontend и backend корректно работают с ними как со строками, а не пытаются преобразовать через parseInt(). Несоответствие типов приводит к ошибкам "invalid input syntax for type uuid".
- **Осторожно с зависимостями в useCallback/useEffect:** Включение изменяющихся состояний в зависимости useCallback может создать бесконечные циклы ререндера. Используйте useRef для стабильных ссылок на функции, если нужно избежать пересоздания.
- **Фильтрация дубликатов при infinite scroll:** API может возвращать дублирующиеся данные при пагинации. Всегда фильтруйте дубликаты по уникальному ID при добавлении новых элементов к существующему списку, чтобы избежать конфликтов ключей в React.
- **Единообразие в API запросах:** Всегда используйте централизованный API клиент вместо прямых fetch запросов. Это обеспечивает корректную маршрутизацию на нужный порт, единообразную обработку ошибок и авторизацию.
- **Проверка структуры БД перед написанием запросов:** Перед использованием колонки в SQL запросе проверьте реальную структуру таблицы в базе данных. Названия колонок в коде могут не соответствовать реальной схеме БД.
- **Content-Disposition для файлов:** Для изображений, которые должны отображаться в браузере, используйте `Content-Disposition: inline`. Заголовок `attachment` заставляет браузер скачивать файл вместо отображения.

# Current Status / Progress Tracking

Исправлена проблема с отображением адресов пользователя:
- Выявлена ошибка в функциях ProfilePage.tsx - функции fetchAddresses, fetchHolidays, fetchOrders неправильно обрабатывали ответ от API клиента
- API клиент api.get() уже возвращает распарсенные данные, но код пытался вызывать response.ok и response.json()
- Исправлены все функции работы с API для унификации использования API клиента
- Теперь адреса должны корректно отображаться в профиле пользователя

## Executor's Feedback or Assistance Requests

**ВЫПОЛНЕНО: Исправление ошибки с UUID при работе с праздниками и адресами**

Обнаружена и исправлена критическая ошибка с типами данных:

1. **Проблема:** 
   - В базе данных таблицы `user_holidays` и `user_addresses` используют UUID для id колонок
   - В контроллерах `userController.js` код пытался преобразовать ID через `parseInt()` 
   - Это приводило к ошибке "invalid input syntax for type uuid" при попытке обновления/удаления

2. **Исправленные функции backend:**
   - `getHolidayById()` - убран parseInt для holidayId
   - `updateHoliday()` - убран parseInt для holidayId  
   - `deleteHoliday()` - убран parseInt для holidayId
   - `getAddressById()` - убран parseInt для addressId
   - `updateAddress()` - убран parseInt для addressId
   - `deleteAddress()` - убран parseInt для addressId
   - `setAddressAsDefault()` - убран parseInt для addressId

3. **Исправления frontend:**
   - Изменены типы интерфейсов Address и Holiday: `id: number` → `id: string`
   - Обновлены сигнатуры функций для работы со строковыми UUID

4. **Результат:**
   - Устранена ошибка "invalid input syntax for type uuid"
   - Теперь операции с адресами и праздниками работают корректно
   - UUID корректно передаются между frontend и backend

**РАНЕЕ ВЫПОЛНЕНО: Исправление отображения адресов пользователя**

Проблема была в неправильной обработке ответов API в ProfilePage.tsx:

1. **Исправленные функции:**
   - `fetchAddresses()` - убрана проверка response.ok и response.json(), теперь использует data напрямую от api.get()
   - `fetchHolidays()` - аналогично исправлена
   - `fetchOrders()` - аналогично исправлена
   - `handleAddressSubmit()` - переписана для использования api.post()/api.put() вместо прямого fetch
   - `setDefaultAddress()` - убрана проверка response.ok
   - `deleteAddress()` - убрана проверка response.ok  
   - `deleteHoliday()` - убрана проверка response.ok
   - `handleHolidaySubmit()` - переписана для использования api.post()/api.put()

2. **Корень проблемы:** 
   - API клиент (config/api.ts) уже обрабатывает ошибки и возвращает готовые данные
   - Функции ProfilePage пытались обрабатывать ответ как обычный fetch response
   - Это приводило к ошибкам и блокировало отображение данных

3. **Результат:** 
   - Адреса теперь должны корректно загружаться и отображаться в профиле
   - Исправлена работа всех CRUD операций с адресами и праздниками
   - Унифицировано использование API клиента во всех функциях

# Lessons

- При возникновении ошибок 404 сначала нужно проверить структуру базы данных и убедиться что все таблицы созданы
- Миграции базы данных критично важны для работы функционала
- Всегда нужно применять миграции после внесения изменений в схему БД

# План действий

## Изменения в навбаре
1. Удалить компонент поиска из навбара
2. Заменить иконку меню на текст "Меню"

## Анализ корзины и необходимых API

### Текущие API эндпоинты
1. Корзина:
   - GET /api/cart - получение содержимого корзины
   - PUT /api/cart/item/:id - обновление количества товара
   - DELETE /api/cart/item/:id - удаление товара из корзины
   - DELETE /api/cart/clear - очистка корзины

2. Оформление заказа:
   - GET /api/user/addresses - получение адресов пользователя
   - POST /api/orders - создание нового заказа

### Отсутствующие API эндпоинты
1. Адреса:
   - POST /api/user/addresses - добавление нового адреса
   - PUT /api/user/addresses/:id - обновление адреса
   - DELETE /api/user/addresses/:id - удаление адреса
   - PUT /api/user/addresses/:id/default - установка адреса по умолчанию

2. Заказы:
   - GET /api/orders - получение списка заказов пользователя
   - GET /api/orders/:id - получение деталей заказа
   - PUT /api/orders/:id/status - обновление статуса заказа
   - GET /api/orders/:id/tracking - получение информации об отслеживании заказа

3. Доставка:
   - GET /api/delivery/zones - получение зон доставки
   - GET /api/delivery/calculate - расчет стоимости доставки
   - GET /api/delivery/time-slots - получение доступных временных слотов для доставки

4. Платежи:
   - POST /api/payments/create - создание платежа
   - GET /api/payments/:id/status - проверка статуса платежа
   - POST /api/payments/:id/cancel - отмена платежа

## Высокоуровневая разбивка задач

### 1. Изменения в навбаре
- [x] Удалить компонент поиска из навбара
- [x] Заменить иконку меню на текст "Меню"
- [x] Обновить стили для соответствия дизайну

### 2. Разработка недостающих API
- [ ] Реализовать API для работы с адресами
- [ ] Реализовать API для работы с заказами
- [ ] Реализовать API для работы с доставкой
- [ ] Реализовать API для работы с платежами

## Текущий статус / Отслеживание прогресса
- ✅ Завершены изменения в навбаре:
  - Удален компонент поиска
  - Заменена иконка меню на текст "Меню"
  - Обновлены стили
- Анализ необходимых API завершен
- Готовы к реализации недостающих API

## Обратная связь или запросы на помощь
- Требуется подтверждение списка необходимых API
- Нужно уточнить приоритеты разработки API

## Уроки
- При разработке API важно учитывать все возможные сценарии использования
- Необходимо обеспечить безопасность при работе с платежами
- Важно реализовать валидацию данных на бэкенде 