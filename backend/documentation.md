# Документация по проекту цветочного магазина E-Flower-Shop (Backend)

## 1. Обзор проекта

Данный проект представляет собой REST API сервер для интернет-магазина цветов и букетов, разработанный с использованием современных технологий и стандартов. Сервер обеспечивает полный функционал для организации онлайн-торговли цветами и букетами, включая управление товарами, категориями, корзиной покупок, заказами и пользователями.

## 2. Архитектура проекта

Проект разработан с использованием архитектурного паттерна MVC (Model-View-Controller), что обеспечивает четкое разделение бизнес-логики, представления данных и обработки запросов. 

### 2.1 Структура проекта

```
backend/
├── admin/         # Панель администратора
├── config/        # Конфигурационные файлы
├── controllers/   # Контроллеры для обработки запросов
├── db/            # SQL-миграции и схемы
├── logs/          # Логи сервера
├── middleware/    # Промежуточные обработчики
├── models/        # Модели данных
├── public/        # Статические файлы
├── routes/        # Маршруты API
├── scripts/       # Скрипты для инициализации
└── server.js      # Основной файл сервера
```

## 3. Технологический стек

### 3.1 Основные технологии

- **Node.js** (версия 18+) - серверная платформа
- **Express.js** - фреймворк для разработки веб-приложений
- **PostgreSQL** (версия 13+) - реляционная система управления базами данных
- **PM2** - менеджер процессов для Node.js

### 3.2 Ключевые зависимости

- `bcrypt` - шифрование паролей
- `cors` - управление CORS-политиками
- `dotenv` - управление переменными окружения
- `express-rate-limit` - ограничение скорости запросов
- `helmet` - безопасность HTTP-заголовков
- `multer` - загрузка файлов
- `pino` - логирование
- `swagger-jsdoc` и `swagger-ui-express` - документация API
- `uuid` - генерация уникальных идентификаторов

## 4. База данных

### 4.1 Структура базы данных

База данных PostgreSQL содержит следующие основные таблицы:

- `users` - пользователи системы
- `sessions` - сессии пользователей
- `categories` - категории товаров
- `subcategories` - подкатегории товаров
- `products` - товары (обычные и букеты)
- `flowers` - цветы для составления букетов
- `bouquet_flowers` - связь между букетами и цветами
- `reviews` - отзывы пользователей
- `files` - загруженные файлы и изображения
- `cart_items` - элементы корзины пользователя
- `orders` - заказы
- `order_items` - элементы заказа
- `user_holidays` - праздники пользователей
- `user_addresses` - адреса пользователей

### 4.2 Особенности модели данных

Проект использует UUID для идентификаторов всех записей, что обеспечивает более высокий уровень безопасности и лучшую масштабируемость. Также реализованы триггеры для автоматического пересчета цены букетов при изменении цен на составляющие их цветы.

## 5. API-интерфейсы

### 5.1 Основные эндпоинты

Сервер предоставляет следующие группы API-эндпоинтов:

- `/api/auth` - аутентификация и управление сессиями
- `/api/products` - управление товарами
- `/api/categories` - управление категориями и подкатегориями
- `/api/flowers` - управление цветами
- `/api/cart` - управление корзиной покупок
- `/api/orders` - управление заказами
- `/api/reviews` - управление отзывами
- `/api/user` - управление пользователями
- `/api/files` - загрузка и управление файлами
- `/api/admin` - административные функции

### 5.2 Документация API

API-документация реализована с использованием Swagger и доступна по адресу `/api-docs`. Документация предоставляет полное описание всех эндпоинтов, параметров и возвращаемых значений.

## 6. Безопасность

### 6.1 Аутентификация и авторизация

В проекте реализована система аутентификации на основе сессий с использованием cookies. Пароли пользователей хранятся в БД в хешированном виде с использованием bcrypt. Система ролей разделяет пользователей на обычных пользователей и администраторов.

### 6.2 Защита от атак

- **Защита от XSS** - использование библиотеки Helmet
- **Защита от брутфорс-атак** - ограничение скорости запросов (rate limiting)
- **Защита от CSRF** - проверка и валидация запросов
- **Безопасные HTTP-заголовки** - настройка заголовков для предотвращения атак

## 7. Производительность и оптимизация

### 7.1 Индексирование базы данных

В проекте используются оптимизированные индексы для ускорения поиска и фильтрации данных:
- Индексы для поиска по категориям и подкатегориям
- Индексы для поиска товаров и отзывов
- Индексы для фильтрации заказов пользователя

### 7.2 Кэширование

Для улучшения производительности реализовано кэширование часто используемых данных, таких как категории и популярные товары.

## 8. Логирование и мониторинг

Проект использует библиотеку Pino для логирования действий в системе. Логи сохраняются в директории `logs/` и ротируются каждые 3 часа. PM2 используется для управления процессом сервера и мониторинга его состояния.

## 9. Деплой и управление приложением

### 9.1 Подготовка к деплою

Для развертывания приложения необходимо:
1. Клонировать репозиторий
2. Создать конфигурационный файл `.env`
3. Установить зависимости и инициализировать БД (`npm run build`)
4. Запустить сервер через PM2 (`npm run pm2:prod`)

### 9.2 Управление сервером

Для управления сервером используются команды PM2:
- Мониторинг: `npm run pm2:monit`
- Просмотр логов: `npm run pm2:logs`
- Перезапуск: `npm run pm2:restart`
- Остановка: `npm run pm2:stop`

## 10. Особенности реализации бизнес-логики

### 10.1 Система формирования букетов

Реализована гибкая система для составления букетов из отдельных цветов с автоматическим расчетом цены букета на основе стоимости отдельных цветов и их количества.

### 10.2 Персонализация для пользователей

В системе реализован функционал для сохранения праздников и адресов пользователя, что позволяет персонализировать предложения и упростить процесс оформления заказа.

### 10.3 Система отзывов и рейтинга

Реализована полноценная система отзывов пользователей с возможностью оценки товаров и автоматическим пересчетом среднего рейтинга для каждого товара.

## 11. Заключение

Данный проект представляет собой современное, хорошо структурированное REST API для интернет-магазина цветов с полным набором функций для электронной коммерции. Архитектура проекта обеспечивает масштабируемость, безопасность и высокую производительность. 